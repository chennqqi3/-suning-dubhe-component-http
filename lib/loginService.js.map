{"version":3,"sources":["../src/loginService.js"],"names":["main","app","service","baseUrl","loginCallbackStack","intervalVar","currentLocation","config","base","loginTheme","jumpLogin","data","redirectUrl","window","location","href","newlocationHref","origin","host","match","self","top","hash","encodeURIComponent","popupLoginContainer","src","successCallbackUrl","document","getElementById","style","display","setInterval","checkMsgFromLoginIframe","resizeContainer","widthAndHeight","value","split","width","height","loginIframe","marginLeft","marginTop","closeContainer","indexOf","clearInterval","undefined","loginSuccess","dequeue","popupClose","reject","newHash","length","params","enqueue","resolve","push","callbacks","pop","logout","authId","env","cupidlogout","option","cookie","beforeService","snlogout","hostname","detectEnv","cookies","is_cupid_auth","forEach","test","e","trim","fn","module","exports"],"mappings":";;AAAA,IAAIA,OAAO,SAAPA,IAAO,CAAUC,GAAV,EAAe;AACtBA,QAAIC,OAAJ,CAAY,cAAZ,EAA4B,CAAC,SAAD,EAAY,UAAUC,OAAV,EAAmB;AACvD;AACA,YAAIC,qBAAqB,EAAzB;AACA,YAAIC,WAAJ;AACA,YAAIC,eAAJ;;AAEA,YAAIC,SAAS;AACTC,kBAAML,UAAU,EADP;AAETM,wBAAY;AAFH,SAAb;;AAKA,iBAASC,SAAT,CAAmBC,IAAnB,EAAyB;AACrB,gBAAIA,KAAKC,WAAT,EAAsB;AAClBC,uBAAOC,QAAP,CAAgBC,IAAhB,GAAuBJ,KAAKC,WAA5B;AACH,aAFD,MAEO;AACH,oBAAII,kBAAkBF,SAASG,MAAT,GAAkBV,OAAOC,IAAzB,GAAgC,iBAAhC,GAAoDM,SAASC,IAAnF;;AAEA,oBAAID,SAASI,IAAT,CAAcC,KAAd,CAAoB,KAApB,KAA8BL,SAASI,IAAT,CAAcC,KAAd,CAAoB,KAApB,CAA9B,IAA4DL,SAASI,IAAT,IAAiB,iBAAjF,EAAoG;AAChG,wBAAIE,SAASC,GAAb,EAAkB;AACdL,0CAAkB,0FAA0FK,IAAIP,QAAJ,CAAaQ,IAAzH;AACAD,4BAAIP,QAAJ,CAAaC,IAAb,GAAoB,sDAAsDR,OAAOE,UAA7D,GAA0E,WAA1E,GAAwFc,mBAAmBP,eAAnB,CAA5G;AACH,qBAHD,MAGO;AACHF,iCAASC,IAAT,GAAgB,sDAAsDR,OAAOE,UAA7D,GAA0E,WAA1E,GAAwFc,mBAAmBP,eAAnB,CAAxG;AACH;AACJ,iBAPD,MAOO;AACH,wBAAII,SAASC,GAAb,EAAkB;AACdL,0CAAkB,oFAAoFK,IAAIP,QAAJ,CAAaQ,IAAnH;AACAD,4BAAIP,QAAJ,CAAaC,IAAb,GAAoB,mDAAmDR,OAAOE,UAA1D,GAAuE,WAAvE,GAAqFc,mBAAmBP,eAAnB,CAAzG;AACH,qBAHD,MAGO;AACHF,iCAASC,IAAT,GAAgB,mDAAmDR,OAAOE,UAA1D,GAAuE,WAAvE,GAAqFc,mBAAmBP,eAAnB,CAArG;AACH;AACJ;AACJ;AACJ;;AAED,iBAASQ,mBAAT,GAA+B;AAC3B,gBAAI,OAAOnB,WAAP,IAAsB,WAA1B,EAAuC;AACnCC,kCAAkBO,OAAOC,QAAP,CAAgBC,IAAlC;AACA,oBAAIU,MAAM,CAAE,OAAOlB,OAAOmB,kBAAd,IAAoC,WAArC,GACNnB,OAAOC,IAAP,GAAc,oBADR,GACgCD,OAAOmB,kBADxC,IAC8D,cAD9D,GAC+EH,mBAAmBjB,eAAnB,CAD/E,GACqH,cADrH,GACsIC,OAAOE,UADvJ;;AAGAkB,yBAASC,cAAT,CAAwB,cAAxB,EAAwCC,KAAxC,CAA8CC,OAA9C,GAAwD,OAAxD;AACAH,yBAASC,cAAT,CAAwB,gBAAxB,EAA0CC,KAA1C,CAAgDC,OAAhD,GAA0D,OAA1D;AACAH,yBAASC,cAAT,CAAwB,aAAxB,EAAuCH,GAAvC,GAA6CA,GAA7C;;AAEApB,8BAAcQ,OAAOkB,WAAP,CAAmBC,uBAAnB,EAA4C,GAA5C,CAAd;AACH;AACJ;;AAED,iBAASC,eAAT,CAAyBC,cAAzB,EAAyC;AACrC;AACA,gBAAIC,QAAQD,eAAeE,KAAf,CAAqB,GAArB,CAAZ;AACA,gBAAIC,QAAQF,MAAM,CAAN,CAAZ;AACA,gBAAIG,SAASH,MAAM,CAAN,CAAb;AACA,gBAAII,cAAcZ,SAASC,cAAT,CAAwB,aAAxB,CAAlB;AACAW,wBAAYV,KAAZ,CAAkBQ,KAAlB,GAA0BA,QAAQ,IAAlC;AACAE,wBAAYV,KAAZ,CAAkBS,MAAlB,GAA2BA,SAAS,IAApC;AACAC,wBAAYV,KAAZ,CAAkBW,UAAlB,GAA+B,CAACH,KAAD,GAAS,CAAT,GAAa,IAA5C;AACAE,wBAAYV,KAAZ,CAAkBY,SAAlB,GAA8B,CAACH,MAAD,GAAU,CAAV,GAAc,IAA5C;AACH;;AAED,iBAASI,cAAT,GAA0B;AACtBf,qBAASC,cAAT,CAAwB,cAAxB,EAAwCC,KAAxC,CAA8CC,OAA9C,GAAwD,MAAxD;AACAH,qBAASC,cAAT,CAAwB,gBAAxB,EAA0CC,KAA1C,CAAgDC,OAAhD,GAA0D,MAA1D;AACAH,qBAASC,cAAT,CAAwB,aAAxB,EAAuCH,GAAvC,GAA6C,EAA7C;AACAZ,mBAAOC,QAAP,CAAgBC,IAAhB,GAAwBT,gBAAgBqC,OAAhB,CAAwB,GAAxB,KAAgC,CAAC,CAAlC,GAAuCrC,kBAAkB,UAAzD,GAAsEA,eAA7F;AACAsC,0BAAcvC,WAAd;AACAA,0BAAcwC,SAAd;AACH;;AAED,iBAASC,YAAT,GAAwB;AACpBJ;AACAK;AACH;;AAED,iBAASC,UAAT,GAAsB;AAClBN;AACAO;AACH;;AAED,iBAASjB,uBAAT,GAAmC;AAC/B,gBAAIkB,UAAUrC,OAAOC,QAAP,CAAgBQ,IAA9B;AACA,gBAAI4B,QAAQC,MAAR,GAAiB,CAArB,EAAwB;AACpB,oBAAIhB,QAAQe,QAAQd,KAAR,CAAc,GAAd,CAAZ;AACA,oBAAIgB,SAASjB,MAAM,CAAN,EAASC,KAAT,CAAe,GAAf,CAAb;AACA,wBAAQgB,OAAO,CAAP,CAAR;AACI,yBAAK,QAAL;AACInB,wCAAgBmB,OAAO,CAAP,CAAhB;AACA;AACJ,yBAAK,OAAL;AACIV;AACA;AACJ,yBAAK,cAAL;AACII;AACA;AACJ;AACI;AAXR;AAaH;AACJ;;AAED,iBAASO,OAAT,CAAiBC,OAAjB,EAA0BL,MAA1B,EAAkC;AAC9B7C,+BAAmBmD,IAAnB,CAAwB;AACpBD,yBAASA,OADW;AAEpBL,wBAAQA;AAFY,aAAxB;AAIH;;AAED,iBAASF,OAAT,GAAmB;AACf;AACA,gBAAIS,YAAYpD,mBAAmBqD,GAAnB,MAA4B,EAA5C;AACA,gBAAID,UAAUF,OAAd,EAAuB;AACnBE,0BAAUF,OAAV;AACH;AACJ;;AAED,iBAASL,MAAT,GAAkB;AACd,gBAAIO,YAAYpD,mBAAmBqD,GAAnB,MAA4B,EAA5C;AACA,gBAAID,UAAUP,MAAd,EAAsB;AAClBO,0BAAUP,MAAV;AACH;AACJ;;AAED,eAAO;AACHjB,qCAAyBA,uBADtB;AAEHU,4BAAgBA,cAFb;AAGHI,0BAAcA,YAHX;AAIHb,6BAAiBA,eAJd;AAKHT,iCAAqBA,mBALlB;AAMH6B,qBAASA,OANN;AAOH9C,oBAAQA,MAPL;AAQH;AACAyC,wBAAYA,UATT;AAUHtC,uBAAWA,SAVR;AAWHgD;AAXG,SAAP;AAaH,KAxI2B,CAA5B;AAyIH,CA1ID;;AA4IA,IAAIC,MAAJ,EAAYC,GAAZ;;AAEA,SAASC,WAAT,GAAkC;AAAA,QAAbC,MAAa,uEAAJ,EAAI;;AAC9B;AACAnC,aAASoC,MAAT,GAAkB,2FAAlB;AACAjD,aAASC,IAAT,GAAgB,uDAAuD4C,MAAvD,IAAiEG,OAAOE,aAAP,GAAuB,MAAMF,OAAOE,aAApC,GAAoD,EAArH,IAA2H,WAA3H,GAAyIzC,mBAAmBuC,OAAO5D,OAAP,GAAiB4D,OAAO5D,OAAxB,GAAmCY,SAASG,MAAV,GAAoB,wBAApB,GAAgDH,SAASC,IAA9G,CAAzJ;AACH;;AAED,SAASkD,QAAT,GAA+B;AAAA,QAAbH,MAAa,uEAAJ,EAAI;;AAC3B;AACA,QAAIhD,SAASoD,QAAT,CAAkB/C,KAAlB,CAAwB,KAAxB,KAAkCL,SAASoD,QAAT,CAAkB/C,KAAlB,CAAwB,KAAxB,CAAtC,EAAsE;AAClEL,iBAASC,IAAT,GAAgB,oDAAoDQ,mBAAmBuC,OAAO5D,OAAP,GAAiB4D,OAAO5D,OAAxB,GAAkCY,SAASC,IAA9D,CAApE;AACH,KAFD,MAEO,IAAID,SAASoD,QAAT,CAAkB/C,KAAlB,CAAwB,KAAxB,CAAJ,EAAoC;AACvCL,iBAASC,IAAT,GAAgB,oDAAoDQ,mBAAmBuC,OAAO5D,OAAP,GAAiB4D,OAAO5D,OAAxB,GAAkCY,SAASC,IAA9D,CAApE;AACH,KAFM,MAEA;AACH;AACAD,iBAASC,IAAT,GAAgB,iDAAiDQ,mBAAmBuC,OAAO5D,OAAP,GAAiB4D,OAAO5D,OAAxB,GAAkCY,SAASC,IAA9D,CAAjE;AACH;AACJ;;AAED,SAASoD,SAAT,GAAqB;AACjB,QAAIC,UAAUzC,SAASoC,MAAT,CAAgB3B,KAAhB,CAAsB,GAAtB,CAAd;AACA,QAAIiC,gBAAgB,KAApB;AACA,QAAID,OAAJ,EAAa;AACTA,gBAAQE,OAAR,CAAgB,aAAK;AACjB,gBAAI,SAASC,IAAT,CAAcC,CAAd,CAAJ,EAAsB;AAClBb,yBAASa,EAAEC,IAAF,EAAT;AACH;AACD,gBAAI,gBAAgBF,IAAhB,CAAqBC,CAArB,CAAJ,EAA6B;AACzBH,gCAAgB,IAAhB;AACH;AACJ,SAPD;AAQH;AACD,QAAIA,aAAJ,EAAmB;AACf,eAAO,OAAP;AACH,KAFD,MAEO;AACH,eAAO,IAAP;AACH;AACJ;;AAED,SAASX,MAAT,CAAgBI,MAAhB,EAAwB;AACpB,QAAI,CAACF,GAAL,EAAU;AACNA,cAAMO,WAAN;AACH;AACD,YAAQP,GAAR;AACI,aAAK,IAAL;AACIK,qBAASH,MAAT;AACA;AACJ,aAAK,OAAL;AACID,wBAAYC,MAAZ;AACA;AACJ;AACI;AARR;AAUH;;AAED9D,KAAK0E,EAAL,GAAU;AACNhB;AADM,CAAV;;AAIAiB,OAAOC,OAAP,GAAiB5E,IAAjB","file":"loginService.js","sourcesContent":["var main = function (app) {\r\n    app.service(\"LoginService\", ['baseUrl', function (baseUrl) {\r\n        /* passport相关的东西 */\r\n        var loginCallbackStack = [];\r\n        var intervalVar;\r\n        var currentLocation;\r\n\r\n        var config = {\r\n            base: baseUrl + '',\r\n            loginTheme: \"sncd\"\r\n        };\r\n\r\n        function jumpLogin(data) {\r\n            if (data.redirectUrl) {\r\n                window.location.href = data.redirectUrl\r\n            } else {\r\n                var newlocationHref = location.origin + config.base + 'auth?targetUrl=' + location.href;\r\n\r\n                if (location.host.match('sit') || location.host.match('dev') || location.host == 'my.cnsuning.com') {\r\n                    if (self !== top) {\r\n                        newlocationHref = \"http://phoebussit.cnsuning.com/phoebus/auth?targetUrl=http://phoebussit.cnsuning.com/\" + top.location.hash\r\n                        top.location.href = 'https://ssosit.cnsuning.com/ids/login?loginTheme=' + config.loginTheme + '&service=' + encodeURIComponent(newlocationHref)\r\n                    } else {\r\n                        location.href = 'https://ssosit.cnsuning.com/ids/login?loginTheme=' + config.loginTheme + '&service=' + encodeURIComponent(newlocationHref)\r\n                    }\r\n                } else {\r\n                    if (self !== top) {\r\n                        newlocationHref = \"http://phoebus.cnsuning.com/phoebus/auth?targetUrl=http://phoebus.cnsuning.com/\" + top.location.hash\r\n                        top.location.href = 'https://sso.cnsuning.com/ids/login?loginTheme=' + config.loginTheme + '&service=' + encodeURIComponent(newlocationHref)\r\n                    } else {\r\n                        location.href = 'https://sso.cnsuning.com/ids/login?loginTheme=' + config.loginTheme + '&service=' + encodeURIComponent(newlocationHref)\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        function popupLoginContainer() {\r\n            if (typeof intervalVar == 'undefined') {\r\n                currentLocation = window.location.href;\r\n                var src = ((typeof config.successCallbackUrl == 'undefined') ?\r\n                    (config.base + \"popupLoginSuccess?\") : config.successCallbackUrl) + \"topLocation=\" + encodeURIComponent(currentLocation) + \"&loginTheme=\" + config.loginTheme;\r\n\r\n                document.getElementById('modalOverlay').style.display = 'block';\r\n                document.getElementById('modalContainer').style.display = 'block';\r\n                document.getElementById(\"iframeLogin\").src = src;\r\n\r\n                intervalVar = window.setInterval(checkMsgFromLoginIframe, 200);\r\n            }\r\n        }\r\n\r\n        function resizeContainer(widthAndHeight) {\r\n            //        document.getElementById(\"modalOverlay\").style.display = \"block\";\r\n            var value = widthAndHeight.split(\",\");\r\n            var width = value[0];\r\n            var height = value[1];\r\n            var loginIframe = document.getElementById(\"iframeLogin\");\r\n            loginIframe.style.width = width + 'px';\r\n            loginIframe.style.height = height + 'px';\r\n            loginIframe.style.marginLeft = -width / 2 + 'px';\r\n            loginIframe.style.marginTop = -height / 2 + 'px';\r\n        }\r\n\r\n        function closeContainer() {\r\n            document.getElementById('modalOverlay').style.display = 'none';\r\n            document.getElementById('modalContainer').style.display = 'none';\r\n            document.getElementById(\"iframeLogin\").src = '';\r\n            window.location.href = (currentLocation.indexOf('#') == -1) ? currentLocation + \"#unknown\" : currentLocation;\r\n            clearInterval(intervalVar);\r\n            intervalVar = undefined;\r\n        }\r\n\r\n        function loginSuccess() {\r\n            closeContainer();\r\n            dequeue();\r\n        }\r\n\r\n        function popupClose() {\r\n            closeContainer();\r\n            reject();\r\n        }\r\n\r\n        function checkMsgFromLoginIframe() {\r\n            var newHash = window.location.hash;\r\n            if (newHash.length > 1) {\r\n                var value = newHash.split('#');\r\n                var params = value[1].split(':');\r\n                switch (params[0]) {\r\n                    case 'resize':\r\n                        resizeContainer(params[1]);\r\n                        break;\r\n                    case 'close':\r\n                        closeContainer();\r\n                        break;\r\n                    case 'loginSuccess':\r\n                        loginSuccess();\r\n                        break;\r\n                    default:\r\n                        break;\r\n                }\r\n            }\r\n        }\r\n\r\n        function enqueue(resolve, reject) {\r\n            loginCallbackStack.push({\r\n                resolve: resolve,\r\n                reject: reject\r\n            });\r\n        }\r\n\r\n        function dequeue() {\r\n            // 这里面还需要修改\r\n            var callbacks = loginCallbackStack.pop() || {};\r\n            if (callbacks.resolve) {\r\n                callbacks.resolve();\r\n            }\r\n        }\r\n\r\n        function reject() {\r\n            var callbacks = loginCallbackStack.pop() || {};\r\n            if (callbacks.reject) {\r\n                callbacks.reject();\r\n            }\r\n        }\r\n\r\n        return {\r\n            checkMsgFromLoginIframe: checkMsgFromLoginIframe,\r\n            closeContainer: closeContainer,\r\n            loginSuccess: loginSuccess,\r\n            resizeContainer: resizeContainer,\r\n            popupLoginContainer: popupLoginContainer,\r\n            enqueue: enqueue,\r\n            config: config,\r\n            //add hw 2015-06-30\r\n            popupClose: popupClose,\r\n            jumpLogin: jumpLogin,\r\n            logout,\r\n        };\r\n    }]);\r\n}\r\n\r\nvar authId, env\r\n\r\nfunction cupidlogout(option = {}) {\r\n    //非sn passport\r\n    document.cookie = 'is_cupid_auth=false; expires=Thu, 01 Jan 1970 00:00:00 UTC; domain=.cnsuning.com; path=/;'\r\n    location.href = 'http://cupidsit.cnsuning.com/cupid/session/logout?' + authId + (option.beforeService ? '&' + option.beforeService : '') + '&service=' + encodeURIComponent(option.service ? option.service : (location.origin) + '/cupid/auth?targetUrl=' + (location.href))\r\n}\r\n\r\nfunction snlogout(option = {}) {\r\n    //sn passport\r\n    if (location.hostname.match('sit') || location.hostname.match('dev')) {\r\n        location.href = 'https://ssosit.cnsuning.com/ids/logout?service=' + encodeURIComponent(option.service ? option.service : location.href)\r\n    } else if (location.hostname.match('pre')) {\r\n        location.href = 'https://ssopre.cnsuning.com/ids/logout?service=' + encodeURIComponent(option.service ? option.service : location.href)\r\n    } else {\r\n        //location.href = 'http://sso.cnsuning.com/ids/logout?service=http://snds.cnsuning.com/'\r\n        location.href = 'https://sso.cnsuning.com/ids/logout?service=' + encodeURIComponent(option.service ? option.service : location.href)\r\n    }\r\n}\r\n\r\nfunction detectEnv() {\r\n    var cookies = document.cookie.split(';')\r\n    var is_cupid_auth = false\r\n    if (cookies) {\r\n        cookies.forEach(e => {\r\n            if (/authId/.test(e)) {\r\n                authId = e.trim()\r\n            }\r\n            if (/is_cupid_auth/.test(e)) {\r\n                is_cupid_auth = true\r\n            }\r\n        })\r\n    }\r\n    if (is_cupid_auth) {\r\n        return 'cupid'\r\n    } else {\r\n        return 'sn'\r\n    }\r\n}\r\n\r\nfunction logout(option) {\r\n    if (!env) {\r\n        env = detectEnv()\r\n    }\r\n    switch (env) {\r\n        case 'sn':\r\n            snlogout(option)\r\n            return\r\n        case 'cupid':\r\n            cupidlogout(option)\r\n            return\r\n        default:\r\n            break\r\n    }\r\n}\r\n\r\nmain.fn = {\r\n    logout\r\n}\r\n\r\nmodule.exports = main"]}