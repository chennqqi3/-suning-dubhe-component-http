{"version":3,"sources":["../src/httpService.js"],"names":["module","exports","app","httpOpt","httpLoading","loadNum","factory","status","url","onloadingDiv","document","getElementById","match","classList","remove","add","service","setting","name","value","names","i","length","permHeader","$http","$q","$document","$location","AlertService","LoginService","EventBus","baseUrl","Loading","ErrorHandle","HttpSetting","loginUrl","config","base","Date","busy","body","style","cssText","idle","sendRequest","params","method","option","data","defer","displayLoading","notDisplayLoading","resourceCode","headers","defaults","common","location","href","isMajorData","success","result","handle","then","resolve","reject","error","reason","errorContent","undefined","errorresponse","errortext","alert","title","content","promise","addHeaders","param","restful","httpType","unrestricted"],"mappings":"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","file":"httpService.js","sourcesContent":["module.exports = function (app, httpOpt = {\r\n    httpLoading: 'manual'\r\n}) {\r\n    var loadNum = 0\r\n    app.factory('Loading', () => (status, url) => {\r\n        var onloadingDiv = document.getElementById('onloadingDiv')\r\n        if (!onloadingDiv) return\r\n\r\n        if (status) {\r\n            if (url.match('isReposNameRepeat')) return\r\n\r\n            loadNum++\r\n            onloadingDiv.classList.remove('hidden')\r\n        } else {\r\n            loadNum--\r\n            if (loadNum <= 0) {\r\n                loadNum = 0\r\n                onloadingDiv.classList.add('hidden')\r\n            }\r\n        }\r\n    })\r\n    app.service('HttpSetting', [function () {\r\n        let setting = {}\r\n\r\n        function add(name, value) {\r\n            setting[name] = value\r\n        }\r\n\r\n        function match(name) {\r\n            let names = Object.keys(setting)\r\n            for (let i = 0; i < names.length; i++) {\r\n                if (name.match(names[i])) {\r\n                    return {\r\n                        name: names[i],\r\n                        permHeader: setting[names[i]]\r\n                    }\r\n                }\r\n            }\r\n            return {}\r\n        }\r\n\r\n        function remove(name) {\r\n            delete setting[name]\r\n        }\r\n\r\n        return {\r\n            add,\r\n            match,\r\n            remove\r\n        }\r\n    }])\r\n    app.service(\"HttpService\", [\"$http\", \"$q\", \"$document\", \"$location\",\r\n        \"AlertService\", \"LoginService\", \"EventBus\", \"baseUrl\", 'Loading', \"ErrorHandle\", \"HttpSetting\",\r\n        function ($http, $q, $document, $location, AlertService, LoginService, EventBus, baseUrl, Loading, ErrorHandle, HttpSetting) {\r\n            var loginUrl = LoginService.config.base + 'authStatus?callback=JSON_CALLBACK&_t=' + (+new Date());\r\n\r\n            function busy(url) {\r\n                document.body.style.cssText = \"cursor: progress !important\";\r\n                Loading(true, url)\r\n            }\r\n\r\n            function idle() {\r\n                document.body.style.cssText = \"\";\r\n                Loading(false)\r\n            }\r\n\r\n            function sendRequest(url, params, method, option) {\r\n                var data, config\r\n                var defer = $q.defer();\r\n\r\n                if (httpOpt && httpOpt.httpLoading === 'manual') {\r\n                    if (option && option.displayLoading) {\r\n                        busy(url);\r\n                    }\r\n                } else {\r\n                    if (!option || (option && !option.notDisplayLoading)) {\r\n                        busy(url);\r\n                    }\r\n                }\r\n\r\n\r\n                resourceCode(option)\r\n\r\n                if (method === 'post' || method === 'put') {\r\n                    params.data && (params.data = JSON.stringify(params.data))\r\n                }\r\n\r\n                if (method === 'get' || method === 'delete') {\r\n                    data = params\r\n                } else {\r\n                    data = params.data\r\n                    config = {\r\n                        headers: params.headers\r\n                    }\r\n                }\r\n\r\n                $http.defaults.headers.common['currentUrl'] = location.href;\r\n\r\n                //如果url匹配，设置权限设置头部\r\n                let {\r\n                    name,\r\n                    permHeader\r\n                } = HttpSetting.match(url)\r\n                if (permHeader) {\r\n                    for (let i in permHeader) {\r\n                        $http.defaults.headers.common[i] = permHeader[i]\r\n                    }\r\n                    if (permHeader.isMajorData) {\r\n                        HttpSetting.remove(name)\r\n                    }\r\n                }\r\n\r\n                $http[method](url, data, config).success(function (result) {\r\n                    idle();\r\n\r\n                    ErrorHandle.handle(result)\r\n                        .then(function (data) {\r\n                            defer.resolve(data);\r\n                        }, function (data) {\r\n                            defer.reject(data);\r\n                        });\r\n                }).error(function (reason, status) {\r\n                    idle();\r\n\r\n                    var errorContent = reason;\r\n                    if (reason != undefined && reason.errorresponse != undefined) {\r\n                        errorContent = reason.errorresponse.errortext;\r\n                    }\r\n\r\n                    if (status) {\r\n                        AlertService.alert({\r\n                            title: \"服务端异常\",\r\n                            content: '系统出了点小问题，请稍后重试！'\r\n                            //content: errorContent\r\n                        });\r\n                    }\r\n                    defer.reject(reason);\r\n                });\r\n\r\n                for (let i in permHeader) {\r\n                    delete $http.defaults.headers.common[i]\r\n                }\r\n\r\n                return defer.promise;\r\n            }\r\n\r\n            function resourceCode(option) {\r\n                if (option && option.resourceCode) {\r\n                    $http.defaults.headers.common.resourceCode = option.resourceCode\r\n                } else {\r\n                    delete $http.defaults.headers.common.resourceCode\r\n                }\r\n            }\r\n\r\n            function addHeaders(method, param) {\r\n                switch (method) {\r\n                    case 'get':\r\n                        return {\r\n                            params: param\r\n                        }\r\n                    case 'post':\r\n                        return {\r\n                            data: param || {},\r\n                            headers: {\r\n                                'Content-Type': 'application/json'\r\n                            }\r\n                        }\r\n                    case 'delete':\r\n                        return {\r\n                            data: JSON.stringify(param || {}),\r\n                            headers: {\r\n                                'Content-Type': 'application/json'\r\n                            }\r\n                        }\r\n                    case 'put':\r\n                        return {\r\n                            data: param || {},\r\n                            headers: {\r\n                                'Content-Type': 'application/json'\r\n                            }\r\n                        }\r\n                }\r\n            }\r\n\r\n            function restful(httpType) {\r\n                return function (url, param, option) {\r\n                    var defer = $q.defer();\r\n\r\n                    if (option && option.unrestricted) {\r\n                        sendRequest(baseUrl + url, {\r\n                            params: param\r\n                        }, httpType, option).then(\r\n                            function (result) {\r\n                                defer.resolve(result);\r\n                            },\r\n                            function (data) {\r\n                                defer.reject(data);\r\n                            });\r\n                    } else {\r\n                        sendRequest(baseUrl + url, addHeaders(httpType, param), httpType, option).then(\r\n                            function (result) {\r\n                                defer.resolve(result);\r\n                            },\r\n                            function (data) {\r\n                                defer.reject(data);\r\n                            }\r\n                        );\r\n                    }\r\n\r\n                    return defer.promise;\r\n                }\r\n            }\r\n\r\n            return {\r\n                \"get\": restful('get'),\r\n                \"post\": restful('post'),\r\n                \"put\": restful('put'),\r\n                \"delete\": restful('delete'),\r\n            };\r\n        }\r\n    ]);\r\n}"]}