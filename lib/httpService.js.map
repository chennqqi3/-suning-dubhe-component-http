{"version":3,"sources":["../src/httpService.js"],"names":["module","exports","app","loadNum","factory","status","url","onloadingDiv","document","getElementById","match","classList","remove","add","service","$http","$q","$document","$location","AlertService","LoginService","EventBus","baseUrl","Loading","ErrorHandle","loginUrl","config","base","Date","busy","body","style","cssText","idle","sendRequest","params","method","option","data","defer","notDisplayLoading","resourceCode","headers","defaults","common","location","href","success","result","handle","then","resolve","reject","error","reason","errorContent","undefined","errorresponse","errortext","alert","title","content","promise","addHeaders","param","restful","httpType","unrestricted"],"mappings":";;;;;;;;AAAAA,OAAOC,OAAP,GAAiB,UAAUC,GAAV,EAAe;AAC5B,QAAIC,UAAU,CAAd;AACAD,QAAIE,OAAJ,CAAY,SAAZ,EAAuB;AAAA,eAAM,UAACC,MAAD,EAASC,GAAT,EAAiB;AAC1C,gBAAIC,eAAeC,SAASC,cAAT,CAAwB,cAAxB,CAAnB;AACA,gBAAI,CAACF,YAAL,EAAmB;;AAEnB,gBAAIF,MAAJ,EAAY;AACR,oBAAIC,IAAII,KAAJ,CAAU,mBAAV,CAAJ,EAAoC;;AAEpCP;AACAI,6BAAaI,SAAb,CAAuBC,MAAvB,CAA8B,QAA9B;AACH,aALD,MAKO;AACHT;AACA,oBAAIA,WAAW,CAAf,EAAkB;AACdA,8BAAU,CAAV;AACAI,iCAAaI,SAAb,CAAuBE,GAAvB,CAA2B,QAA3B;AACH;AACJ;AACJ,SAhBsB;AAAA,KAAvB;AAiBAX,QAAIY,OAAJ,CAAY,aAAZ,EAA2B,CAAC,OAAD,EAAU,IAAV,EAAgB,WAAhB,EAA6B,WAA7B,EACvB,cADuB,EACP,cADO,EACS,UADT,EACqB,SADrB,EACgC,SADhC,EAC2C,aAD3C,EAEvB,UAAUC,KAAV,EAAiBC,EAAjB,EAAqBC,SAArB,EAAgCC,SAAhC,EAA2CC,YAA3C,EAAyDC,YAAzD,EAAuEC,QAAvE,EAAiFC,OAAjF,EAA0FC,OAA1F,EAAmGC,WAAnG,EAAgH;AAC5G,YAAIC,WAAWL,aAAaM,MAAb,CAAoBC,IAApB,GAA2B,uCAA3B,GAAsE,CAAC,IAAIC,IAAJ,EAAtF;;AAEA,iBAASC,IAAT,CAAcvB,GAAd,EAAmB;AACfE,qBAASsB,IAAT,CAAcC,KAAd,CAAoBC,OAApB,GAA8B,6BAA9B;AACAT,oBAAQ,IAAR,EAAcjB,GAAd;AACH;;AAED,iBAAS2B,IAAT,GAAgB;AACZzB,qBAASsB,IAAT,CAAcC,KAAd,CAAoBC,OAApB,GAA8B,EAA9B;AACAT,oBAAQ,KAAR;AACH;;AAED,iBAASW,WAAT,CAAqB5B,GAArB,EAA0B6B,MAA1B,EAAkCC,MAAlC,EAA0CC,MAA1C,EAAkD;AAC9C,gBAAIC,IAAJ,EAAUZ,MAAV;AACA,gBAAIa,QAAQvB,GAAGuB,KAAH,EAAZ;AACA,gBAAI,CAACF,MAAD,IAAYA,UAAU,CAACA,OAAOG,iBAAlC,EAAsD;AAClDX,qBAAKvB,GAAL;AACH;;AAEDmC,yBAAaJ,MAAb;;AAEA,gBAAID,WAAW,MAAX,IAAqBA,WAAW,KAApC,EAA2C;AACvCD,uBAAOG,IAAP,KAAgBH,OAAOG,IAAP,GAAc,yBAAeH,OAAOG,IAAtB,CAA9B;AACH;;AAED,gBAAIF,WAAW,KAAX,IAAoBA,WAAW,QAAnC,EAA6C;AACzCE,uBAAOH,MAAP;AACH,aAFD,MAEO;AACHG,uBAAOH,OAAOG,IAAd;AACAZ,yBAAS;AACLgB,6BAASP,OAAOO;AADX,iBAAT;AAGH;;AAED3B,kBAAM4B,QAAN,CAAeD,OAAf,CAAuBE,MAAvB,CAA8B,YAA9B,IAA8CC,SAASC,IAAvD;;AAEA/B,kBAAMqB,MAAN,EAAc9B,GAAd,EAAmBgC,IAAnB,EAAyBZ,MAAzB,EAAiCqB,OAAjC,CAAyC,UAAUC,MAAV,EAAkB;AACvDf;;AAEAT,4BAAYyB,MAAZ,CAAmBD,MAAnB,EACKE,IADL,CACU,UAAUZ,IAAV,EAAgB;AAClBC,0BAAMY,OAAN,CAAcb,IAAd;AACH,iBAHL,EAGO,UAAUA,IAAV,EAAgB;AACfC,0BAAMa,MAAN,CAAad,IAAb;AACH,iBALL;AAMH,aATD,EASGe,KATH,CASS,UAAUC,MAAV,EAAkBjD,MAAlB,EAA0B;AAC/B4B;;AAEA,oBAAIsB,eAAeD,MAAnB;AACA,oBAAIA,UAAUE,SAAV,IAAuBF,OAAOG,aAAP,IAAwBD,SAAnD,EAA8D;AAC1DD,mCAAeD,OAAOG,aAAP,CAAqBC,SAApC;AACH;;AAED,oBAAIrD,MAAJ,EAAY;AACRc,iCAAawC,KAAb,CAAmB;AACfC,+BAAO,OADQ;AAEfC,iCAAS;AACT;AAHe,qBAAnB;AAKH;AACDtB,sBAAMa,MAAN,CAAaE,MAAb;AACH,aAzBD;;AA2BA,mBAAOf,MAAMuB,OAAb;AACH;;AAED,iBAASrB,YAAT,CAAsBJ,MAAtB,EAA8B;AAC1B,gBAAIA,UAAUA,OAAOI,YAArB,EAAmC;AAC/B1B,sBAAM4B,QAAN,CAAeD,OAAf,CAAuBE,MAAvB,CAA8BH,YAA9B,GAA6CJ,OAAOI,YAApD;AACH,aAFD,MAEO;AACH,uBAAO1B,MAAM4B,QAAN,CAAeD,OAAf,CAAuBE,MAAvB,CAA8BH,YAArC;AACH;AACJ;;AAED,iBAASsB,UAAT,CAAoB3B,MAApB,EAA4B4B,KAA5B,EAAmC;AAC/B,oBAAQ5B,MAAR;AACI,qBAAK,KAAL;AACI,2BAAO;AACHD,gCAAQ6B;AADL,qBAAP;AAGJ,qBAAK,MAAL;AACI,2BAAO;AACH1B,8BAAM0B,SAAS,EADZ;AAEHtB,iCAAS;AACL,4CAAgB;AADX;AAFN,qBAAP;AAMJ,qBAAK,QAAL;AACI,2BAAO;AACHJ,8BAAM,yBAAe0B,SAAS,EAAxB,CADH;AAEHtB,iCAAS;AACL,4CAAgB;AADX;AAFN,qBAAP;AAMJ,qBAAK,KAAL;AACI,2BAAO;AACHJ,8BAAM0B,SAAS,EADZ;AAEHtB,iCAAS;AACL,4CAAgB;AADX;AAFN,qBAAP;AApBR;AA2BH;;AAED,iBAASuB,OAAT,CAAiBC,QAAjB,EAA2B;AACvB,mBAAO,UAAU5D,GAAV,EAAe0D,KAAf,EAAsB3B,MAAtB,EAA8B;AACjC,oBAAIE,QAAQvB,GAAGuB,KAAH,EAAZ;;AAEA,oBAAIF,UAAUA,OAAO8B,YAArB,EAAmC;AAC/BjC,gCAAYZ,UAAUhB,GAAtB,EAA2B;AACvB6B,gCAAQ6B;AADe,qBAA3B,EAEGE,QAFH,EAEa7B,MAFb,EAEqBa,IAFrB,CAGI,UAAUF,MAAV,EAAkB;AACdT,8BAAMY,OAAN,CAAcH,MAAd;AACH,qBALL,EAMI,UAAUV,IAAV,EAAgB;AACZC,8BAAMa,MAAN,CAAad,IAAb;AACH,qBARL;AASH,iBAVD,MAUO;AACHJ,gCAAYZ,UAAUhB,GAAtB,EAA2ByD,WAAWG,QAAX,EAAqBF,KAArB,CAA3B,EAAwDE,QAAxD,EAAkE7B,MAAlE,EAA0Ea,IAA1E,CACI,UAAUF,MAAV,EAAkB;AACdT,8BAAMY,OAAN,CAAcH,MAAd;AACH,qBAHL,EAII,UAAUV,IAAV,EAAgB;AACZC,8BAAMa,MAAN,CAAad,IAAb;AACH,qBANL;AAQH;;AAED,uBAAOC,MAAMuB,OAAb;AACH,aAzBD;AA0BH;;AAED,eAAO;AACH,mBAAOG,QAAQ,KAAR,CADJ;AAEH,oBAAQA,QAAQ,MAAR,CAFL;AAGH,mBAAOA,QAAQ,KAAR,CAHJ;AAIH,sBAAUA,QAAQ,QAAR;AAJP,SAAP;AAMH,KA9IsB,CAA3B;AAgJH,CAnKD","file":"httpService.js","sourcesContent":["module.exports = function (app) {\r\n    var loadNum = 0\r\n    app.factory('Loading', () => (status, url) => {\r\n        var onloadingDiv = document.getElementById('onloadingDiv')\r\n        if (!onloadingDiv) return\r\n\r\n        if (status) {\r\n            if (url.match('isReposNameRepeat')) return\r\n\r\n            loadNum++\r\n            onloadingDiv.classList.remove('hidden')\r\n        } else {\r\n            loadNum--\r\n            if (loadNum <= 0) {\r\n                loadNum = 0\r\n                onloadingDiv.classList.add('hidden')\r\n            }\r\n        }\r\n    })\r\n    app.service(\"HttpService\", [\"$http\", \"$q\", \"$document\", \"$location\",\r\n        \"AlertService\", \"LoginService\", \"EventBus\", \"baseUrl\", 'Loading', \"ErrorHandle\",\r\n        function ($http, $q, $document, $location, AlertService, LoginService, EventBus, baseUrl, Loading, ErrorHandle) {\r\n            var loginUrl = LoginService.config.base + 'authStatus?callback=JSON_CALLBACK&_t=' + (+new Date());\r\n\r\n            function busy(url) {\r\n                document.body.style.cssText = \"cursor: progress !important\";\r\n                Loading(true, url)\r\n            }\r\n\r\n            function idle() {\r\n                document.body.style.cssText = \"\";\r\n                Loading(false)\r\n            }\r\n\r\n            function sendRequest(url, params, method, option) {\r\n                var data, config\r\n                var defer = $q.defer();\r\n                if (!option || (option && !option.notDisplayLoading)) {\r\n                    busy(url);\r\n                }\r\n\r\n                resourceCode(option)\r\n\r\n                if (method === 'post' || method === 'put') {\r\n                    params.data && (params.data = JSON.stringify(params.data))\r\n                }\r\n\r\n                if (method === 'get' || method === 'delete') {\r\n                    data = params\r\n                } else {\r\n                    data = params.data\r\n                    config = {\r\n                        headers: params.headers\r\n                    }\r\n                }\r\n\r\n                $http.defaults.headers.common['currentUrl'] = location.href;\r\n\r\n                $http[method](url, data, config).success(function (result) {\r\n                    idle();\r\n\r\n                    ErrorHandle.handle(result)\r\n                        .then(function (data) {\r\n                            defer.resolve(data);\r\n                        }, function (data) {\r\n                            defer.reject(data);\r\n                        });\r\n                }).error(function (reason, status) {\r\n                    idle();\r\n\r\n                    var errorContent = reason;\r\n                    if (reason != undefined && reason.errorresponse != undefined) {\r\n                        errorContent = reason.errorresponse.errortext;\r\n                    }\r\n\r\n                    if (status) {\r\n                        AlertService.alert({\r\n                            title: \"服务端异常\",\r\n                            content: '系统出了点小问题，请稍后重试！'\r\n                            //content: errorContent\r\n                        });\r\n                    }\r\n                    defer.reject(reason);\r\n                });\r\n\r\n                return defer.promise;\r\n            }\r\n\r\n            function resourceCode(option) {\r\n                if (option && option.resourceCode) {\r\n                    $http.defaults.headers.common.resourceCode = option.resourceCode\r\n                } else {\r\n                    delete $http.defaults.headers.common.resourceCode\r\n                }\r\n            }\r\n\r\n            function addHeaders(method, param) {\r\n                switch (method) {\r\n                    case 'get':\r\n                        return {\r\n                            params: param\r\n                        }\r\n                    case 'post':\r\n                        return {\r\n                            data: param || {},\r\n                            headers: {\r\n                                'Content-Type': 'application/json'\r\n                            }\r\n                        }\r\n                    case 'delete':\r\n                        return {\r\n                            data: JSON.stringify(param || {}),\r\n                            headers: {\r\n                                'Content-Type': 'application/json'\r\n                            }\r\n                        }\r\n                    case 'put':\r\n                        return {\r\n                            data: param || {},\r\n                            headers: {\r\n                                'Content-Type': 'application/json'\r\n                            }\r\n                        }\r\n                }\r\n            }\r\n\r\n            function restful(httpType) {\r\n                return function (url, param, option) {\r\n                    var defer = $q.defer();\r\n\r\n                    if (option && option.unrestricted) {\r\n                        sendRequest(baseUrl + url, {\r\n                            params: param\r\n                        }, httpType, option).then(\r\n                            function (result) {\r\n                                defer.resolve(result);\r\n                            },\r\n                            function (data) {\r\n                                defer.reject(data);\r\n                            });\r\n                    } else {\r\n                        sendRequest(baseUrl + url, addHeaders(httpType, param), httpType, option).then(\r\n                            function (result) {\r\n                                defer.resolve(result);\r\n                            },\r\n                            function (data) {\r\n                                defer.reject(data);\r\n                            }\r\n                        );\r\n                    }\r\n\r\n                    return defer.promise;\r\n                }\r\n            }\r\n\r\n            return {\r\n                \"get\": restful('get'),\r\n                \"post\": restful('post'),\r\n                \"put\": restful('put'),\r\n                \"delete\": restful('delete'),\r\n            };\r\n        }\r\n    ]);\r\n}"]}